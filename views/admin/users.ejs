<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Manage Users | MediBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >
</head>

<body class="bg-light">

<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/admin">MediBook Admin</a>
    <a href="/admin" class="btn btn-outline-light btn-sm">Dashboard</a>
  </div>
</nav>

<div class="container py-5" style="max-width: 1200px;">

  <h3 class="fw-bold mb-4">Manage Users</h3>

  <!-- SEARCH BAR -->
<div class="card shadow-sm mb-4">
  <div class="card-body">

    <form method="GET" action="/admin/users" class="row g-3">

<div class="col-12 col-md-10">
        <input 
          type="text"
          name="search"
          class="form-control"
          placeholder="Search by name or email..."
          value="<%= search || '' %>"
        >
      </div>

<div class="col-12 col-md-2">
        <button class="btn btn-dark w-100">
          Search
        </button>
      </div>

    </form>

  </div>
</div>


  <% if (users.length === 0) { %>
    <div class="alert alert-warning">
      No users found.
    </div>
  <% } else { %>

  <div class="card shadow-sm">
    <div class="card-body">

      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>

          <tbody>

            <% users.forEach(u => { %>
              <tr>
                <td class="fw-bold"><%= u.full_name %></td>
                <td><%= u.email %></td>
                <td>
                  <% if (u.role === 'admin') { %>
                    <span class="badge bg-dark">Admin</span>
                  <% } else if (u.role === 'practitioner') { %>
                    <span class="badge bg-success">Practitioner</span>
                  <% } else { %>
                    <span class="badge bg-secondary">Patient</span>
                  <% } %>
                </td>

                <td class="text-end">

                  <% if (u.role === 'patient') { %>

                    <!-- Promote to Practitioner -->
                    <form
                      method="POST"
                      action="/admin/users/<%= u.id %>/make-practitioner"
class="d-flex flex-column flex-md-row gap-2 align-items-stretch"
                    >
                      <select name="service_id" class="form-select form-select-sm" required>
                        <option value="">Service</option>
                        <% services.forEach(s => { %>
                          <option value="<%= s.id %>">
                            <%= s.name %>
                          </option>
                        <% }) %>
                      </select>

                      <button class="btn btn-sm btn-success">
                        Make Practitioner
                      </button>
                    </form>

                  <% } else if (u.role === 'practitioner') { %>

                    <!-- Demote back to Patient -->
                    <form
                      method="POST"
                      action="/admin/users/<%= u.id %>/make-patient"
                      class="d-inline"
                      onsubmit="return confirm('Remove practitioner access?');"
                    >
                      <button class="btn btn-sm btn-danger">
                        Make Patient
                      </button>
                    </form>

                  <% } %>

                  <!-- Admin cannot be changed -->
                </td>

              </tr>
            <% }) %>

          </tbody>
        </table>
      </div>

    </div>
  </div>

  <% } %>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Book Appointment | MediBook</title>

  <!-- Bootstrap -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <style>
    :root{
      --brand:#0d6efd;
      --brand2:#0b5ed7;
      --ok:#198754;
      --ok2:#157347;
      --cardRadius:22px;
    }

    body { background:#f6f8fb; }

    /* Header card */
    .page-card{
      border-radius: var(--cardRadius);
      border: 1px solid rgba(0,0,0,.06);
    }

    /* Step title */
    .step-title{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      margin-bottom: 12px;
    }
    .step-badge{
      width:28px;height:28px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(13,110,253,.12);
      color: var(--brand);
      font-weight:800;
    }

    /* Service cards (PC-first 4 in a row) */
    .service-grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:14px;
    }

    .service-btn{
      width:100%;
      height:92px;
      border-radius: 18px;
      border: 2px solid rgba(13,110,253,.25);
      background:#fff;
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      text-align:left;
      padding:14px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
    }
    .service-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(13,110,253,.12);
      border-color: rgba(13,110,253,.45);
    }
    .service-btn.active{
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      color:#fff;
      border-color: transparent;
      box-shadow: 0 12px 30px rgba(13,110,253,.25);
    }
    .service-name{
      font-weight:800;
      font-size:18px;
      line-height:1.1;
    }
    .service-price{
      font-weight:700;
      opacity:.95;
    }
    .service-pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(13,110,253,.08);
      color: var(--brand);
      font-weight:700;
      white-space:nowrap;
    }
    .service-btn.active .service-pill{
      background: rgba(255,255,255,.18);
      color:#fff;
    }

    /* Layout for practitioners */
    .results-wrap{
      margin-top: 22px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 16px;
    }

    .side-card,
    .main-card{
      border-radius: var(--cardRadius);
      border: 1px solid rgba(0,0,0,.06);
      background:#fff;
    }

    /* Practitioner list */
    .prac-item{
      border-radius: 16px;
      border: 1px solid rgba(0,0,0,.08);
      padding: 12px 12px;
      cursor:pointer;
      transition: background .12s ease, box-shadow .12s ease, transform .12s ease, border-color .12s ease;
    }
    .prac-item:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0,0,0,.08);
      border-color: rgba(13,110,253,.35);
    }
    .prac-item.active{
      border-color: rgba(13,110,253,.65);
      box-shadow: 0 12px 26px rgba(13,110,253,.12);
      background: rgba(13,110,253,.04);
    }
    .prac-name{
      font-weight:800;
      font-size:16px;
      margin:0;
    }
    .prac-sub{
      margin:0;
      font-size:13px;
      color:#6c757d;
    }

    /* Date chips */
    .date-strip{
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom: 6px;
    }
    .date-chip{
      border: 1px solid rgba(0,0,0,.12);
      background:#fff;
      border-radius: 14px;
      padding: 10px 12px;
      min-width: 140px;
      text-align:left;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
    }
    .date-chip:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(0,0,0,.08);
      border-color: rgba(13,110,253,.35);
    }
    .date-chip.active{
      background: rgba(13,110,253,.08);
      border-color: rgba(13,110,253,.65);
    }
    .date-chip .d1{ font-weight:800; font-size:14px; }
    .date-chip .d2{ font-size:12px; color:#6c757d; }

    /* Time grid */
    .time-grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .slot-btn{
      height: 52px;
      border-radius: 16px;
      font-weight:800;
      border: 2px solid rgba(25,135,84,.25);
      background:#fff;
      color: var(--ok);
      transition: transform .12s ease, box-shadow .12s ease, background .12s ease, border-color .12s ease;
      width:100%;
    }
    .slot-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(25,135,84,.12);
      border-color: rgba(25,135,84,.55);
      background: rgba(25,135,84,.06);
    }
    .slot-btn.selected{
      background: linear-gradient(135deg, var(--ok), var(--ok2));
      color:#fff;
      border-color: transparent;
      box-shadow: 0 14px 30px rgba(25,135,84,.22);
    }

    /* Confirmation bar */
    .confirm-bar{
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.06);
      background: #fff;
      padding: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      position: sticky;
      bottom: 14px;
      box-shadow: 0 16px 40px rgba(0,0,0,.10);
      margin-top: 16px;
    }
    .confirm-meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-size:13px;
      color:#6c757d;
    }
    .meta-pill{
      padding:6px 10px;
      border-radius:999px;
      background:#f1f3f5;
      color:#495057;
      font-weight:700;
    }
    .confirm-btn{
      border-radius: 14px;
      height: 44px;
      font-weight:800;
      padding: 0 18px;
    }

    /* Helpers */
    .muted-hint{
      color:#6c757d;
      font-size:13px;
    }

    /* Responsive later, but keep it usable if window is small */
    @media (max-width: 1100px){
      .service-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); }
      .results-wrap{ grid-template-columns: 1fr; }
      .time-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
  </style>
</head>

<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-dark">
  <div class="container">
    <a class="navbar-brand fw-bold" href="/patient">MediBook</a>
    <a href="/patient" class="btn btn-outline-light btn-sm">Dashboard</a>
  </div>
</nav>

<div class="container py-5" style="max-width: 1100px">

  <div class="card shadow-sm p-4 page-card">

    <h3 class="fw-bold mb-4 text-center">Book Appointment</h3>

    <!-- STEP 1 -->
    <div class="mb-4">
      <div class="step-title">
        <div class="step-badge">1</div>
        <div>Choose a service</div>
      </div>

      <div class="service-grid">
        <% services.forEach(s => { %>
          <button
            type="button"
            class="service-btn service-btn-js"
            data-service="<%= s.id %>"
            data-name="<%= s.name %>"
            data-price="<%= s.price %>"
          >
            <div>
              <div class="service-name"><%= s.name %></div>
              <div class="service-price">Â£<%= s.price %></div>
            </div>
            <div class="service-pill">Tap to view</div>
          </button>
        <% }) %>
      </div>

      <div class="mt-2 muted-hint">
        Tip: Choose a service first, then pick a practitioner, date, and time.
      </div>
    </div>

    <!-- STEP 2 + 3 -->
    <div id="slotsContainer"></div>

  </div>
</div>

<script>
  const slotsContainer = document.getElementById("slotsContainer");
  const serviceButtons = document.querySelectorAll(".service-btn-js");

  // UI state
  let state = {
    serviceId: null,
    serviceName: null,
    practitioners: [],
    selectedPractitionerId: null,
    selectedDate: null,
    selectedTime: null
  };

  // Utilities
  function escapeHtml(str){
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function formatNiceDate(yyyyMmDd){
    const d = new Date(yyyyMmDd + "T00:00:00");
    const opts = { weekday: "short", day: "2-digit", month: "short" };
    return d.toLocaleDateString("en-GB", opts); // e.g. Sat, 14 Feb
  }

  function resetSelectionAfterService(){
    state.selectedPractitionerId = null;
    state.selectedDate = null;
    state.selectedTime = null;
  }

  function renderLoading(){
    slotsContainer.innerHTML = `
      <div class="text-center text-muted my-4">
        Loading available appointments...
      </div>
    `;
  }

  function renderNoAvailability(){
    slotsContainer.innerHTML = `
      <div class="alert alert-warning mt-3">
        No availability for this service.
      </div>
    `;
  }

  function buildPractitionerList(practitioners){
    // only practitioners that actually have slots
    const available = practitioners.filter(p => p.slots && p.slots.length > 0);

    if (available.length === 0) return "";

    const items = available.map((p, idx) => {
      const active = (state.selectedPractitionerId === p.practitioner_id) || (!state.selectedPractitionerId && idx === 0);
      return `
        <div class="prac-item prac-item-js ${active ? "active" : ""}"
             data-prac="${p.practitioner_id}">
          <p class="prac-name">${escapeHtml(p.practitioner)}</p>
          <p class="prac-sub">View availability</p>
        </div>
      `;
    }).join("");

    return `
      <div class="p-3">
        <div class="fw-bold mb-2">2. Choose a practitioner</div>
        <div class="d-grid gap-2">
          ${items}
        </div>
        <div class="mt-2 muted-hint">
          Only practitioners with available slots are shown.
        </div>
      </div>
    `;
  }

  function getSelectedPractitioner(){
    const p = state.practitioners.find(x => x.practitioner_id === state.selectedPractitionerId);
    return p || null;
  }

  function groupSlotsByDate(slots){
    const grouped = {};
    for (const s of slots){
      if (!grouped[s.date]) grouped[s.date] = [];
      grouped[s.date].push(s.time);
    }
    // sort times
    for (const d in grouped){
      grouped[d].sort();
    }
    return grouped;
  }

  function buildDateStrip(grouped){
    const dates = Object.keys(grouped).sort();
    if (dates.length === 0) return "";

    // select first date if none
    if (!state.selectedDate) state.selectedDate = dates[0];

    return `
      <div class="mb-2">
        <div class="fw-bold mb-2">3. Pick a date</div>
        <div class="date-strip">
          ${dates.map(date => `
            <button type="button"
              class="date-chip date-chip-js ${date === state.selectedDate ? "active" : ""}"
              data-date="${date}">
              <div class="d1">${escapeHtml(formatNiceDate(date))}</div>
              <div class="d2">${escapeHtml(date)}</div>
            </button>
          `).join("")}
        </div>
      </div>
    `;
  }

  function buildTimeGrid(grouped){
    const times = grouped[state.selectedDate] || [];
    if (times.length === 0){
      return `<div class="alert alert-warning mt-3">No times available on this date.</div>`;
    }

    return `
      <div>
        <div class="fw-bold mb-2">4. Pick a time</div>
        <div class="time-grid">
          ${times.map(t => `
            <button type="button"
              class="slot-btn slot-btn-js ${t === state.selectedTime ? "selected" : ""}"
              data-time="${t}">
              ${escapeHtml(t)}
            </button>
          `).join("")}
        </div>
      </div>
    `;
  }

  function buildConfirmBar(){
    const p = getSelectedPractitioner();

    const ready = !!(state.serviceId && p && state.selectedDate && state.selectedTime);

    const metaService = state.serviceName ? `Service: ${state.serviceName}` : "Service: -";
    const metaPrac = p ? `Practitioner: ${p.practitioner}` : "Practitioner: -";
    const metaDate = state.selectedDate ? `Date: ${state.selectedDate}` : "Date: -";
    const metaTime = state.selectedTime ? `Time: ${state.selectedTime}` : "Time: -";

    const disabledAttr = ready ? "" : "disabled";

    return `
      <div class="confirm-bar">
        <div class="confirm-meta">
          <span class="meta-pill">${escapeHtml(metaService)}</span>
          <span class="meta-pill">${escapeHtml(metaPrac)}</span>
          <span class="meta-pill">${escapeHtml(metaDate)}</span>
          <span class="meta-pill">${escapeHtml(metaTime)}</span>
        </div>

        <form method="POST" action="/patient/book" class="m-0">
          <input type="hidden" name="practitioner_id" value="${p ? p.practitioner_id : ""}">
          <input type="hidden" name="booking_date" value="${state.selectedDate || ""}">
          <input type="hidden" name="booking_time" value="${state.selectedTime || ""}">

          <button type="submit"
            class="btn btn-success confirm-btn"
            ${disabledAttr}
            onclick="this.disabled=true; this.innerText='Booking...'; this.form.submit(); return false;">
            Confirm booking
          </button>
        </form>
      </div>
    `;
  }

  function renderResults(){
    // Build a 2-column layout: practitioner list + details
    const availablePractitioners = state.practitioners.filter(p => p.slots && p.slots.length > 0);

    if (availablePractitioners.length === 0){
      renderNoAvailability();
      return;
    }

    // Default select first practitioner if none selected
    if (!state.selectedPractitionerId){
      state.selectedPractitionerId = availablePractitioners[0].practitioner_id;
    }

    const selected = getSelectedPractitioner();
    const grouped = groupSlotsByDate(selected.slots);

    // Reset date/time if chosen date no longer exists
    const dates = Object.keys(grouped).sort();
    if (!dates.includes(state.selectedDate)){
      state.selectedDate = dates[0] || null;
      state.selectedTime = null;
    }
    // If chosen time not on selected date, clear it
    if (state.selectedTime && !(grouped[state.selectedDate] || []).includes(state.selectedTime)){
      state.selectedTime = null;
    }

    slotsContainer.innerHTML = `
      <div class="results-wrap">
        <div class="side-card">
          ${buildPractitionerList(state.practitioners)}
        </div>

        <div class="main-card p-3">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div>
              <div class="fw-bold" style="font-size:18px;">${escapeHtml(selected.practitioner)}</div>
              <div class="muted-hint">Choose a date then time, then confirm.</div>
            </div>
            <span class="badge text-bg-primary" style="border-radius:999px; padding:10px 12px;">
              ${escapeHtml(state.serviceName || "Service")}
            </span>
          </div>

          ${buildDateStrip(grouped)}
          ${buildTimeGrid(grouped)}
          ${buildConfirmBar()}
        </div>
      </div>
    `;

    wireUpResultEvents();
  }

  function wireUpResultEvents(){
    // practitioner click
    document.querySelectorAll(".prac-item-js").forEach(el => {
      el.addEventListener("click", () => {
        const id = Number(el.dataset.prac);
        if (id === state.selectedPractitionerId) return;

        state.selectedPractitionerId = id;
        state.selectedDate = null;
        state.selectedTime = null;
        renderResults();
      });
    });

    // date click
    document.querySelectorAll(".date-chip-js").forEach(el => {
      el.addEventListener("click", () => {
        const d = el.dataset.date;
        if (d === state.selectedDate) return;

        state.selectedDate = d;
        state.selectedTime = null;
        renderResults();
      });
    });

    // time click
    document.querySelectorAll(".slot-btn-js").forEach(el => {
      el.addEventListener("click", () => {
        const t = el.dataset.time;
        state.selectedTime = t;
        renderResults();
      });
    });
  }

  async function loadByService(serviceId, serviceName){
    state.serviceId = serviceId;
    state.serviceName = serviceName;
    resetSelectionAfterService();

    renderLoading();

    const res = await fetch(`/patient/slots-by-service/${serviceId}`);
    const practitioners = await res.json();

    // Save full payload
    state.practitioners = Array.isArray(practitioners) ? practitioners : [];

    if (state.practitioners.length === 0){
      renderNoAvailability();
      return;
    }

    renderResults();
  }

  // Service selection
  serviceButtons.forEach(btn => {
    btn.addEventListener("click", async () => {
      serviceButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");

      const serviceId = btn.dataset.service;
      const serviceName = btn.dataset.name || btn.innerText.trim();

      await loadByService(serviceId, serviceName);
    });
  });

 (function(){
  const params = new URLSearchParams(window.location.search);
  const error = params.get("error");
  if (!error) return;

  const alert = document.createElement("div");
  alert.className = "alert alert-warning";
  alert.style.borderRadius = "16px";

    if (error === "already_booked_same_day") {
    alert.className = "alert alert-danger";
    alert.innerHTML =
      "<strong>You already have a booking on this day.</strong> Only one appointment per day is allowed.";
  }


  if (error === "slot_taken") {
    alert.className = "alert alert-danger";
    alert.innerHTML =
      "<strong>That slot was just taken.</strong> Please choose another time.";
  }

  if (error === "slot_passed") {
    alert.className = "alert alert-warning";
    alert.innerHTML =
      "<strong>This time has already passed.</strong> Please select a future slot.";
  }

  const container = document.querySelector(".page-card");
  container.insertBefore(alert, container.children[1]);
})();

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
